# TODO: Make this file external, downloadable via versioned URL
---
image: kireevco/docker-compose:18.06-fat

services:
  - docker:dind

stages:
  - build
  - test
  - deploy

before_script:
  - apk add --no-cache make # TODO: this should be part of the compose image
  - make auth
  - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
  - |
    if [[ -f Dockerrun.aws.json ]]; then
      sed -i "s/:latest/:${CI_PIPELINE_ID}/g" Dockerrun.aws.json
    fi

Compile:
  stage: build
  except:
    - tags
  artifacts:
    paths:
      - logs/
      - node_modules/
      - dist
      - /root/.npm/_logs

    expire_in: 1 week
    # Cache modules in between jobs
  cache:
    key: "$CI_PROJECT_NAME-$CI_COMMIT_REF_SLUG"
    paths:
      - .npm/
      - node_modules

  script:
    - docker pull ${CI_REGISTRY_IMAGE}:latest || true
    - docker pull ${CI_REGISTRY_IMAGE}:build || true
    - make build
    - docker tag ${CI_REGISTRY_IMAGE}:${CI_PIPELINE_ID} ${CI_REGISTRY_IMAGE}:latest
    - docker push ${CI_REGISTRY_IMAGE}:build
    - docker push ${CI_REGISTRY_IMAGE}:${CI_PIPELINE_ID}
    - docker push ${CI_REGISTRY_IMAGE}:latest

Sanity:
  stage: test
  allow_failure: true
  artifacts:
    when: always
    paths:
      # Collect logs
      - build.log
      - /root/.npm/_logs

  dependencies:
    - Compile
  script:
    - make test | tee build.log

Dev:
  stage: deploy
  dependencies:
    - Compile
  except:
    - master
  environment:
    name: dev
    url: https://public-gateway.flocloud.co
  script:
    - make deploy ENV=dev

